# Terraform Review Skill

Terraformコード（`.tf`ファイル）を包括的にレビューするためのスキルです。

## トリガー条件

以下の場合に自動的にレビューを実行します:
- `.tf`ファイルを新規作成した時
- `.tf`ファイルを編集した時

## レビュー観点

### 1. 構文エラー
- HCL構文の誤り
- ブロック構造の不整合
- 属性名の誤り
- 型の不一致

### 2. ベストプラクティス
- リソース命名規則
- モジュール構造
- 変数とoutputの適切な使用
- データソースの活用
- 依存関係の明示（depends_on）
- ライフサイクルルールの適切な使用
- タグ付けの一貫性

### 3. セキュリティ
- 機密情報のハードコード（パスワード、APIキーなど）
- 過度に緩いセキュリティグループルール（0.0.0.0/0）
- 暗号化設定の欠如
- パブリックアクセスの不適切な許可
- IAMポリシーの過剰な権限
- S3バケットのパブリック公開
- RDSの公開設定
- ログ記録の欠如

### 4. パフォーマンス・コスト
- 不要なリソースの作成
- 非効率なデータソースクエリ
- 過剰なインスタンスサイズ
- 削除保護の適切な設定

### 5. 保守性・可読性
- 適切なコメント
- 変数の説明（description）
- モジュールのドキュメント
- リソース名の明確性
- ファイル分割の適切性
- バージョン制約の明示

### 6. State管理
- バックエンド設定の適切性
- State分割の妥当性
- リモートStateの参照

## 出力形式

レビュー結果は以下の形式で出力します:

```markdown
## Terraform レビュー結果

### 🔴 Critical（重大）
即座に修正が必要な問題

**ファイル名:行番号 - リソース名**
- 問題: [問題の説明]
- 影響: [セキュリティリスク/コスト増/データ損失など]
- 修正案:
  ```hcl
  # 修正後のコード
  ```

### 🟡 Warning（警告）
修正を推奨する問題

**ファイル名:行番号 - リソース名**
- 問題: [問題の説明]
- 理由: [なぜ修正すべきか]
- 修正案:
  ```hcl
  # 修正後のコード
  ```

### 🔵 Info（情報）
より良いコードのための提案

**ファイル名:行番号 - リソース名**
- 提案: [改善提案]
- 修正案:
  ```hcl
  # 修正後のコード
  ```

### ✅ Summary（サマリー）
- Total Issues: X件（Critical: X, Warning: X, Info: X）
- Overall Assessment: [Good/Needs Improvement/Critical Issues Found]
- Estimated Monthly Cost Impact: [該当する場合]
```

## レビューの実行方法

1. Terraformファイル全体を読み込む
2. 上記の6つの観点で分析
3. 問題を重要度で分類（Critical > Warning > Info）
4. 各問題に対して具体的な修正案を提示
5. サマリーで全体評価とコスト影響を提供

## 重要度の判定基準

**🔴 Critical:**
- セキュリティ脆弱性（機密情報漏洩、不適切な公開設定）
- データ損失のリスク
- 構文エラー
- コンプライアンス違反

**🟡 Warning:**
- セキュリティベストプラクティス違反
- コスト最適化の機会
- 保守性の問題
- 非推奨機能の使用
- バージョン制約の欠如

**🔵 Info:**
- コードスタイル
- 可読性の改善
- より良いアプローチの提案
- ドキュメント不足

## AWSリソース固有の観点

- EC2: インスタンスタイプ、AMI、セキュリティグループ
- S3: バケットポリシー、暗号化、バージョニング、ログ
- RDS: 公開設定、暗号化、バックアップ、マルチAZ
- IAM: 最小権限の原則、MFA、パスワードポリシー
- VPC: サブネット設計、NACLルール

## ベストプラクティス

- 必ず具体的な修正案を提示する
- 問題の「なぜ」を説明する
- リソース名と行番号を明記する
- 修正前後のコードを示す
- セキュリティ問題は最優先で指摘
- コスト影響がある場合は概算を提示
- 問題がない場合も「問題なし」と明示する

## 使用例

```hcl
# このファイルを保存または編集すると自動的にレビューが実行される

resource "aws_security_group" "example" {
  ingress {
    from_port   = 22
    to_port     = 22
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]  # Criticalな問題を検出
  }
}

resource "aws_db_instance" "example" {
  password = "hardcoded_password"  # Criticalな問題を検出
}
```

上記のような危険な設定を検出し、具体的な修正案を提示します。

## 注意事項

- terraform applyは実行しない（レビューのみ）
- 既存のプロジェクト固有のルールがあれば考慮する
- AWSのベストプラクティスに従う
